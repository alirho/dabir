# نمای کلی معماری

این مستند، معماری داخلی ویرایشگر «دبیر» را شرح می‌دهد تا به توسعه‌دهندگان درک عمیق‌تری از نحوه کارکرد آن بدهد.

## نمودار معماری

معماری «دبیر» به صورت ماژولار طراحی شده است تا هر بخش مسئولیت مشخصی داشته باشد و قابلیت گسترش‌پذیری بالایی فراهم شود.

```mermaid
graph TD
    A[کاربر (ورودی)] --> B{Handlers};
    B -- رویدادهای خام --> C[DabirEditor Core];
    C -- دستورات --> D{Parsers};
    C -- دستورات --> E{Renderer};
    C <--> F[Selection];
    C <--> G[Storage];
    C <--> H{EventEmitter};
    
    D -- HTML --> E;
    E -- به‌روزرسانی DOM --> I[عنصر DOM];
    I -- بازخورد بصری --> A;

    J{Plugins} <--> C;

    subgraph "ماژول‌های اصلی"
        C
        F
        G
        H
    end

    subgraph "پردازش ورودی/خروجی"
        B
        D
        E
        I
    end

    style J fill:#f9f,stroke:#333,stroke-width:2px
```

## توضیح ماژول‌ها

### ۱. هسته (`Core`)

این بخش، قلب ویرایشگر است و وظیفه هماهنگی بین تمام ماژول‌های دیگر را بر عهده دارد.

-   **`DabirEditor`**: کلاس اصلی که تمام ماژول‌ها را راه‌اندازی و مدیریت می‌کند. API عمومی ویرایشگر را ارائه می‌دهد.
-   **`EventEmitter`**: یک سیستم ساده برای مدیریت رویدادها که به ماژول‌ها اجازه می‌دهد بدون وابستگی مستقیم با یکدیگر ارتباط برقرار کنند.
-   **`Selection`**: ابزارهایی برای کار با انتخاب متن (Selection) و محدوده (Range) کاربر در ویرایشگر فراهم می‌کند.
-   **`Storage`**: مسئول ذخیره و بازیابی محتوای ویرایشگر در `localStorage` است.

### ۲. مدیریت‌کننده‌ها (`Handlers`)

این ماژول‌ها به رویدادهای خام مرورگر گوش داده و آن‌ها را به عملیات معنی‌دار برای ویرایشگر تبدیل می‌کنند.

-   **`KeyboardHandler`**: رویدادهای کیبورد را مدیریت می‌کند، مسئول پردازش زنده مارک‌داون در حین تایپ و اجرای میانبرهاست.
-   **`MouseHandler`**: رویدادهای ماوس (مانند کلیک روی تیک‌باکس‌ها) و تغییرات انتخاب متن را مدیریت می‌کند.
-   **`ClipboardHandler`**: عملیات کپی و پیست را مدیریت می‌کند و مسئول تبدیل HTML به مارک‌داون در هنگام کپی است.
-   **`InputHandler`**: به رویداد عمومی `input` گوش می‌دهد و مسئول اصلی ذخیره‌سازی خودکار محتواست.

### ۳. پارسرها (`Parsers`)

این ماژول‌ها وظیفه تبدیل داده از یک فرمت به فرمت دیگر را بر عهده دارند.

-   **`MarkdownParser`**: یک رشته مارک‌داون را به رشته HTML تبدیل می‌کند.
-   **`HtmlParser`**: محتوای HTML ویرایشگر را به مارک‌داون خالص تبدیل می‌کند.
-   **`LiveParser`**: برای پردازش سریع و زنده مارک‌داون در حین تایپ کاربر استفاده می‌شود.
-   **`InlineParser`**: مسئول پردازش قالب‌بندی‌های درون‌خطی مانند `**پررنگ**` و `*کج*` است.

### ۴. رندرکننده (`Renderer`)

-   **`Renderer`**: یک ماژول ساده برای انجام تغییرات در DOM، مانند جایگزین کردن یک بلاک با بلاک دیگر.

### ۵. پلاگین‌ها (`Plugins`)

پلاگین‌ها به ویرایشگر اجازه می‌دهند تا قابلیت‌های جدیدی را بدون تغییر هسته اصلی به دست آورد. هر پلاگین می‌تواند با تمام بخش‌های API ویرایشگر تعامل داشته باشد، پارسرهای جدید اضافه کند یا میانبرهای کیبورد ثبت کند.

## جریان داده (Data Flow)

یک چرخه معمولی در ویرایشگر به صورت زیر است:

1.  **ورودی کاربر**: کاربر یک کلید را فشار می‌دهد (مثلاً `Space` بعد از `## عنوان`).
2.  **Handler**: `KeyboardHandler` رویداد `keyup` را دریافت می‌کند.
3.  **Parser**: `KeyboardHandler` با استفاده از `LiveParser` تشخیص می‌دهد که کاربر در حال نوشتن یک عنوان است.
4.  **Renderer**: `KeyboardHandler` از `Renderer` می‌خواهد تا `<div>` فعلی را با یک تگ `<h2>` جدید جایگزین کند.
5.  **DOM Update**: `Renderer` المان را در DOM جایگزین می‌کند.
6.  **Event Emitter**: `InputHandler` رویداد `input` را دریافت کرده و پس از یک وقفه کوتاه، رویداد `change` را منتشر می‌کند و محتوا را ذخیره می‌کند.

## سیستم پلاگین (Plugin System)

سیستم پلاگین به صورت متمرکز توسط کلاس `DabirEditor` مدیریت می‌شود. در زمان راه‌اندازی، ویرایشگر متد استاتیک `install` هر پلاگین را فراخوانی کرده و نمونه ویرایشگر را به آن پاس می‌دهد. این به پلاگین اجازه می‌دهد تا خود را در سیستم ثبت کند (مثلاً با ثبت میانبر کیبورد).

پلاگین‌ها همچنین می‌توانند یک API برگردانند که در `editor.plugins` ذخیره می‌شود. این API می‌تواند شامل متدهای سفارشی مانند `markdownBlockParser` باشد که توسط هسته ویرایشگر در زمان‌های مناسب فراخوانی می‌شود.
