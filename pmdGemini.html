<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>یادداشت هوشمند</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f0f2f5; margin: 0; padding: 2rem; color: #333; }
        #editor { background-color: white; max-width: 800px; min-height: 90vh; margin: 0 auto; padding: 50px; box-shadow: 0 0 15px rgba(0,0,0,0.1); outline: none; font-size: 18px; line-height: 1.8; white-space: pre-wrap; }
        #editor h1, #editor h2, #editor h3, #editor h4 { margin: 1.5em 0 0.5em; line-height: 1.3; font-weight: 700; }
        #editor h1 { font-size: 2em; } #editor h2 { font-size: 1.75em; } #editor h3 { font-size: 1.5em; } #editor h4 { font-size: 1.25em; }
        #editor blockquote { border-right: 4px solid #e0e0e0; padding-right: 1.5em; margin: 1em 0; color: #555; background-color: #f9f9f9; }
        #editor strong { font-weight: 700; } #editor em { font-style: italic; } #editor del { text-decoration: line-through; color: #888; }
        #editor a { color: #007bff; text-decoration: none; cursor: pointer; } #editor a:hover { text-decoration: underline; }
        #editor:empty:before { content: attr(data-placeholder); color: #999; pointer-events: none; }

        /* ۱. استایل برای لیست نامرتب اضافه شد */
        #editor ul, #editor ol {
            padding-right: 2em;
            margin: 1em 0;
        }
        #editor li {
            padding-right: 0.5em;
            margin-bottom: 0.5em;
        }
    </style>
</head>
<body>
    <div id="editor" contenteditable="true" data-placeholder="اینجا بنویسید..."></div>

    <script>
        const editor = document.getElementById('editor');
        window.addEventListener('load', () => { const savedContent = localStorage.getItem('mySmartNote'); if (savedContent) { editor.innerHTML = savedContent; } });
        editor.addEventListener('input', () => { localStorage.setItem('mySmartNote', editor.innerHTML); });
        editor.addEventListener('click', (e) => { if (e.target.tagName === 'A') { e.preventDefault(); window.open(e.target.href, '_blank'); } });

        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const parentElement = selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentElement : selection.anchorNode;
                const blockquote = parentElement.closest('blockquote');
                const listItem = parentElement.closest('li');

                if (blockquote && parentElement.textContent.trim() === '' && parentElement !== blockquote) {
                    e.preventDefault();
                    const newPara = document.createElement('div'); newPara.innerHTML = '<br>';
                    blockquote.after(newPara);
                    parentElement.remove();
                    moveCursorToEnd(newPara, selection);
                    localStorage.setItem('mySmartNote', editor.innerHTML);
                    return;
                }

                // ۲. این منطق حالا هم برای لیست مرتب و هم نامرتب کار می‌کند (بدون نیاز به تغییر)
                if (listItem) {
                    if (listItem.textContent.trim() === '') {
                        e.preventDefault();
                        const listElement = listItem.parentElement; // (ul or ol)
                        const newPara = document.createElement('div'); newPara.innerHTML = '<br>';
                        listElement.after(newPara);
                        listItem.remove();
                        if (listElement.children.length === 0) { listElement.remove(); }
                        moveCursorToEnd(newPara, selection);
                    } else {
                        e.preventDefault();
                        const newLi = document.createElement('li'); newLi.innerHTML = '<br>';
                        listItem.after(newLi);
                        moveCursorToEnd(newLi, selection);
                    }
                    localStorage.setItem('mySmartNote', editor.innerHTML);
                }
            }
        });

        editor.addEventListener('keyup', (e) => {
            if (e.key === ' ') {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);
                const node = range.startContainer;

                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.substring(0, range.startOffset);
                    let match;
                    
                    if ((match = text.match(/^(#{1,4}) ([^\n]+?)\s$/))) { /* ... منطق عنوان‌ها ... */ const parentBlock = node.parentElement; if (parentBlock && parentBlock.parentElement === editor) { const level = match[1].length; const content = match[2]; const newHeading = document.createElement(`h${level}`); newHeading.textContent = content; editor.replaceChild(newHeading, parentBlock); moveCursorToEnd(newHeading, selection); localStorage.setItem('mySmartNote', editor.innerHTML); return; } }
                    else if ((match = text.match(/^> ([^\n]*?)\s$/))) { /* ... منطق نقل‌قول ... */ const parentBlock = node.parentElement; if (parentBlock && parentBlock.parentElement === editor) { const content = match[1]; const newQuote = document.createElement('blockquote'); if (content === '') { newQuote.appendChild(document.createElement('br')); } else { newQuote.textContent = content; } editor.replaceChild(newQuote, parentBlock); moveCursorToEnd(newQuote, selection); localStorage.setItem('mySmartNote', editor.innerHTML); return; } }
                    else if ((match = text.match(/^(\d+)\.\s([^\n]*?)\s$/))) { /* ... منطق لیست مرتب ... */ const parentBlock = node.parentElement; if (parentBlock && parentBlock.parentElement === editor) { const content = match[2]; const ol = document.createElement('ol'); const li = document.createElement('li'); const startNum = parseInt(match[1], 10); if (startNum > 1) { ol.setAttribute('start', startNum); } if (content === '') { li.appendChild(document.createElement('br')); } else { li.textContent = content; } ol.appendChild(li); editor.replaceChild(ol, parentBlock); moveCursorToEnd(li, selection); localStorage.setItem('mySmartNote', editor.innerHTML); return; } }
                    // ۳. منطق جدید برای ایجاد لیست نامرتب اضافه شد
                    else if ((match = text.match(/^- ([^\n]*?)\s$/))) {
                        const parentBlock = node.parentElement;
                        if (parentBlock && parentBlock.parentElement === editor) {
                            const content = match[1];
                            const ul = document.createElement('ul');
                            const li = document.createElement('li');

                            if (content === '') { li.appendChild(document.createElement('br')); } 
                            else { li.textContent = content; }
                            
                            ul.appendChild(li);
                            editor.replaceChild(ul, parentBlock);
                            moveCursorToEnd(li, selection);
                            localStorage.setItem('mySmartNote', editor.innerHTML);
                            return;
                        }
                    }
                    
                    if ((match = text.match(/\[([^\]]+)\]\(([^)]+)\)\s$/))) { /* ... منطق پیوند ... */ replaceMarkdown(node, match, (m) => { const a = document.createElement('a'); a.href = m[2]; a.textContent = m[1]; a.target = '_blank'; return a; }); }
                    else if ((match = text.match(/\*\*([^\*]+)\*\*\s$/))) { /* ... منطق پررنگ ... */ replaceMarkdown(node, match, (m) => { const strong = document.createElement('strong'); strong.textContent = m[1]; return strong; }); }
                    else if ((match = text.match(/\*([^\*]+)\*\s$/))) { /* ... منطق کج ... */ replaceMarkdown(node, match, (m) => { const em = document.createElement('em'); em.textContent = m[1]; return em; }); }
                    else if ((match = text.match(/~~([^~]+)~~\s$/))) { /* ... منطق خط خورده ... */ replaceMarkdown(node, match, (m) => { const del = document.createElement('del'); del.textContent = m[1]; return del; }); }
                }
            }
        });
        
        function moveCursorToEnd(element, selection) { const range = document.createRange(); range.selectNodeContents(element); range.collapse(false); selection.removeAllRanges(); selection.addRange(range); }
        function replaceMarkdown(textNode, match, createFn) { if (textNode.parentElement.closest('a, strong, em, del, h1, h2, h3, h4, li')) return; const range = document.createRange(); range.setStart(textNode, match.index); range.setEnd(textNode, match.index + match[0].length - 1); range.deleteContents(); const newElement = createFn(match); range.insertNode(newElement); range.setStartAfter(newElement); range.collapse(true); const spaceNode = document.createTextNode('\u00A0'); range.insertNode(spaceNode); range.setStartAfter(spaceNode); const selection = window.getSelection(); selection.removeAllRanges(); selection.addRange(range); localStorage.setItem('mySmartNote', editor.innerHTML); }
        editor.addEventListener('paste', (e) => { e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text/plain'); document.execCommand('insertText', false, text); });
    </script>
</body>
</html>